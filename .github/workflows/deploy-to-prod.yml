name: "Deploy to production"

on:
  push:
    branches:
      - master

concurrency: prod_deployment

jobs:
  build_cache:
    name: "Build caches"
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout"
        uses: actions/checkout@v2

      - name: "Set cache metadata"
        id: cache-meta
        run: |
          echo "::set-output name=key::${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}"
          echo "::set-output name=yarn-path::$(yarn config get cacheFolder)"
          echo "::set-output name=modules-path::**/node_modules"

      - name: "Check for existing yarn cache"
        uses: actions/cache@v2
        id: yarn-cache
        with:
          key: ${{ steps.cache-meta.outputs.key }}
          path: ${{ steps.cache-meta.outputs.yarn-path }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: "Check for existing node modules cache"
        uses: actions/cache@v2
        id: node-modules-cache
        with:
          key: ${{ steps.cache-meta.outputs.key }}
          path: ${{ steps.cache-meta.outputs.modules-path }}
          restore-keys: |
            ${{ runner.os }}-modules-

      - name: "Install missing dependencies"
        if: ${{ steps.yarn-cache.outputs.cache-hit != 'true' || steps.node-modules-cache.outputs.cache-hit != 'true'}}
        run: yarn install

    outputs:
      key: ${{ steps.cache-meta.outputs.key }}
      yarn-path: ${{ steps.cache-meta.outputs.yarn-path }}
      modules-path: ${{ steps.cache-meta.outputs.modules-path }}

  build_windows_cache:
    name: "Build windows caches"
    runs-on: windows-latest
    steps:
      - name: "Enable long paths"
        run: git config --system core.longpaths true

      - name: "Checkout"
        uses: actions/checkout@v2

      - name: "Set cache metadata"
        id: cache-meta
        run: |
          echo "::set-output name=key::${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}"
          echo "::set-output name=yarn-path::$(yarn config get cacheFolder)"
          echo "::set-output name=modules-path::**/node_modules"

      - name: "Check for existing yarn cache"
        uses: actions/cache@v2
        id: yarn-cache
        with:
          key: ${{ steps.cache-meta.outputs.key }}
          path: ${{ steps.cache-meta.outputs.yarn-path }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: "Check for existing node modules cache"
        uses: actions/cache@v2
        id: node-modules-cache
        with:
          key: ${{ steps.cache-meta.outputs.key }}
          path: ${{ steps.cache-meta.outputs.modules-path }}
          restore-keys: |
            ${{ runner.os }}-modules-

      - name: "Install missing dependencies"
        if: ${{ steps.yarn-cache.outputs.cache-hit != 'true' || steps.node-modules-cache.outputs.cache-hit != 'true'}}
        run: yarn install

    outputs:
      key: ${{ steps.cache-meta.outputs.key }}
      yarn-path: ${{ steps.cache-meta.outputs.yarn-path }}
      modules-path: ${{ steps.cache-meta.outputs.modules-path }}

  package_function_apps:
    name: "Package Function Apps"
    needs: [ build_cache ]
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout"
        uses: actions/checkout@v2

      - name: "Install Function App dependencies"
        run: |
          yarn plugin import workspace-tools
          yarn workspaces focus --production @tsw/function-app-features @tsw/function-app-projections @tsw/function-app-returns

      - name: "Create function app zips"
        run: yarn all:fa:build:zip

      - name: "Collect function apps"
        run: |
          mkdir -p ./function-app-zips
          yarn all:fa:copy-zip

      - name: "Upload function app packages"
        uses: actions/upload-artifact@v2
        with:
          name: function-app-zips
          path: function-app-zips
          if-no-files-found: error

    outputs:
      artifact-name: "function-app-zips"

  deploy_staging_rg_terraform:
    name: "Deploy Staging Resource Group"
    environment: staging
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./terraform/resource_group
    env:
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: 93b71b78-b75b-4806-8282-97b9e70ae16c
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      TF_INPUT: false
    steps:
      - name: "Checkout"
        uses: actions/checkout@v2

      - name: "Setup Terraform"
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: 0.14.7
          terraform_wrapper: false

      - name: "Terraform Init"
        run: |
          terraform init \
            -lock-timeout=15m \
            -backend-config="./backends/staging.backend"

      - name: "Terraform Validate"
        run: terraform validate -no-color

      - name: "Terraform Plan"
        id: rg-plan
        run: |
          terraform plan \
            -lock-timeout=15m \
            -var-file="./var-files/staging.tfvars" \
            -out="staging-rg-plan.tfplan"

      - name: "Terraform Apply"
        run: |
          terraform apply \
            -lock-timeout=15m \
            -auto-approve \
            staging-rg-plan.tfplan

      - name: "Set Terraform Outputs"
        id: set-terraform-outputs
        run: |
          terraform output -json > staging-rg-outputs.json
          echo ::set-output name=resource-group-name::$( jq -r .resource_group_name.value staging-rg-outputs.json )
          echo ::set-output name=artifact-storage-account-name::$( jq -r .artifact_storage_account_name.value staging-rg-outputs.json )
          echo ::set-output name=artifact-container-name::$( jq -r .artifact_container_name.value staging-rg-outputs.json )
          echo ::set-output name=test-artifacts-container-name::$( jq -r .test_artifacts_container_name.value staging-rg-outputs.json )

    outputs:
      resource_group_name: ${{ steps.set-terraform-outputs.outputs.resource-group-name }}
      artifact_storage_account_name: ${{ steps.set-terraform-outputs.outputs.artifact-storage-account-name }}
      artifact_container_name: ${{ steps.set-terraform-outputs.outputs.artifact-container-name }}
      test_artifacts_container_name: ${{ steps.set-terraform-outputs.outputs.test-artifacts-container-name }}

  deploy_staging_apim_terraform:
    name: "Deploy Staging APIM"
    environment: staging
    needs: [ deploy_staging_rg_terraform ]
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./terraform/apim
    env:
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: 93b71b78-b75b-4806-8282-97b9e70ae16c
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      TF_INPUT: false
    steps:
      - name: "Checkout"
        uses: actions/checkout@v2

      - name: "Setup Terraform"
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: 0.14.7
          terraform_wrapper: false

      - name: "Terraform Init"
        run: |
          terraform init \
            -lock-timeout=15m \
            -backend-config="./backends/staging.backend"

      - name: "Terraform Validate"
        run: terraform validate -no-color

      - name: "Terraform Plan"
        run: |
          terraform plan \
            -lock-timeout=15m \
            -var-file="./var-files/staging.tfvars" \
            -out="staging-apim-plan.tfplan"
        env:
          TF_VAR_resource_group_name: ${{ needs.deploy_staging_rg_terraform.outputs.resource_group_name }}
          TF_VAR_myaccount_signing_key: ${{ secrets.MYACCOUNTS_SIGNING_KEY}}
          TF_VAR_xplan_username: ${{ secrets.XPLAN_USERNAME}}
          TF_VAR_xplan_password: ${{ secrets.XPLAN_PASSWORD}}
          TF_VAR_myaccount_guest_username: ${{ secrets.MYACCOUNT_GUEST_USERNAME}}
          TF_VAR_myaccount_guest_password: ${{ secrets.MYACCOUNT_GUEST_PASSWORD}}
          TF_VAR_xplan_app_id: ${{ secrets.XPLAN_APP_ID}}
          TF_VAR_slack_security_alert_webhook_url: ${{ secrets.SLACK_SECURITY_ALERT_WEBHOOK_URL }}

      - name: "Terraform Apply"
        run: |
          terraform apply \
            -lock-timeout=15m \
            -auto-approve \
            staging-apim-plan.tfplan

      - name: "Set Terraform Outputs"
        id: set-terraform-outputs
        run: |
          terraform output -json > staging-apim-outputs.json
          echo ::set-output name=apim-name::$( jq -r .apim_name.value staging-apim-outputs.json )
          echo ::set-output name=apim-vnet-name::$( jq -r .apim_vnet_name.value staging-apim-outputs.json )
          echo ::set-output name=apim-subnet-name::$( jq -r .apim_subnet_name.value staging-apim-outputs.json )
          echo ::set-output name=cdn-profile-website-name::$( jq -r .cdn_profile_website_name.value staging-apim-outputs.json )
          echo ::set-output name=cdn-profile-storybook-name::$( jq -r .cdn_profile_storybook_name.value staging-apim-outputs.json )
          echo ::set-output name=app-insights-name::$( jq -r .app_insights_name.value staging-apim-outputs.json )

    outputs:
      apim_name: ${{ steps.set-terraform-outputs.outputs.apim-name }}
      apim_vnet_name: ${{ steps.set-terraform-outputs.outputs.apim-vnet-name }}
      apim_subnet_name: ${{ steps.set-terraform-outputs.outputs.apim-subnet-name }}
      cdn_profile_website_name: ${{ steps.set-terraform-outputs.outputs.cdn-profile-website-name }}
      cdn_profile_storybook_name: ${{ steps.set-terraform-outputs.outputs.cdn-profile-storybook-name }}
      app_insights_name: ${{ steps.set-terraform-outputs.outputs.app-insights-name }}

  deploy_staging_terraform:
    name: "Deploy Staging Infrastructure."
    environment: staging
    needs:
      - deploy_staging_rg_terraform
      - deploy_staging_apim_terraform
      - package_function_apps
    runs-on: ubuntu-latest
    env:
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: 93b71b78-b75b-4806-8282-97b9e70ae16c
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      TF_INPUT: false
    steps:
      - name: "Checkout"
        uses: actions/checkout@v2

      - name: "Download function app zips"
        uses: actions/download-artifact@v2
        with:
          name: ${{ needs.package_function_apps.outputs.artifact-name }}
          path: ./terraform/infra/zips

      - name: "Setup Terraform"
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: 0.14.7
          terraform_wrapper: false

      - name: "Terraform Init"
        working-directory: ./terraform/infra
        run: |
          terraform init \
            -lock-timeout=15m \
            -backend-config="./backends/staging.backend"

      - name: "Terraform Validate"
        working-directory: ./terraform/infra
        run: terraform validate -no-color

      - name: "Terraform Plan"
        working-directory: ./terraform/infra
        run: |
          terraform plan \
            -lock-timeout=15m \
            -var-file="./var-files/staging.tfvars" \
            -out="staging-infra-plan.tfplan"
        env:
          TF_VAR_resource_group_name: ${{ needs.deploy_staging_rg_terraform.outputs.resource_group_name }}
          TF_VAR_apim_name: ${{ needs.deploy_staging_apim_terraform.outputs.apim_name }}
          TF_VAR_apim_vnet_name: ${{ needs.deploy_staging_apim_terraform.outputs.apim_vnet_name }}
          TF_VAR_apim_subnet_name: ${{ needs.deploy_staging_apim_terraform.outputs.apim_subnet_name }}
          TF_VAR_cdn_profile_website_name: ${{ needs.deploy_staging_apim_terraform.outputs.cdn_profile_website_name }}
          TF_VAR_cdn_profile_storybook_name: ${{ needs.deploy_staging_apim_terraform.outputs.cdn_profile_storybook_name }}
          TF_VAR_app_insights_name: ${{ needs.deploy_staging_apim_terraform.outputs.app_insights_name }}
          TF_VAR_git_branch_name: ${{ github.head_ref }}

      - name: "Terraform Apply"
        working-directory: ./terraform/infra
        run: |
          terraform apply \
            -lock-timeout=15m \
            -auto-approve \
            staging-infra-plan.tfplan

      - name: "Get Terraform Outputs"
        id: get-terraform-outputs
        working-directory: ./terraform/infra
        run: |
          terraform output -json > staging-infra-outputs.json
          echo ::set-output name=frontend-storage-account-name::$( jq -r .frontend_storage_account_name.value staging-infra-outputs.json )
          echo ::set-output name=frontend-web-host::$( jq -r .frontend_web_host.value staging-infra-outputs.json )
          echo ::set-output name=website-endpoint::$( jq -r .frontend_web_endpoint.value staging-infra-outputs.json )
          echo ::set-output name=website-cdn-endpoint-name::$( jq -r .frontend_cdn_endpoint_name.value staging-infra-outputs.json )
          echo ::set-output name=website-cname::$( jq -r .frontend_web_cname.value staging-infra-outputs.json )
          echo ::set-output name=storybook-web-endpoint::$( jq -r .storybook_web_endpoint.value staging-infra-outputs.json )
          echo ::set-output name=storybook-cdn-endpoint-name::$( jq -r .storybook_cdn_endpoint_name.value staging-infra-outputs.json )
          echo ::set-output name=storybook-storage-account-name::$( jq -r .storybook_storage_account_name.value staging-infra-outputs.json )
          echo ::set-output name=api-base-url::$( jq -r .api_base_url.value staging-infra-outputs.json )
          echo ::set-output name=api-endpoints::$( jq -r .api_endpoints.value staging-infra-outputs.json )
          echo ::set-output name=myaccounts-home-url::$( jq -r .myaccounts_home_url.value staging-infra-outputs.json )
          echo ::set-output name=gtm-env-auth::$( jq -r .gtm_env_auth.value staging-infra-outputs.json )
          echo ::set-output name=gtm-env-preview::$( jq -r .gtm_env_preview.value staging-infra-outputs.json )

    outputs:
      frontend_storage_account_name: ${{ steps.get-terraform-outputs.outputs.frontend-storage-account-name }}
      frontend_web_host: ${{ steps.get-terraform-outputs.outputs.frontend-web-host }}
      website_cname: ${{ steps.get-terraform-outputs.outputs.website-cname }}
      website_endpoint: ${{ steps.get-terraform-outputs.outputs.website-endpoint }}
      website_cdn_endpoint_name: ${{ steps.get-terraform-outputs.outputs.website-cdn-endpoint-name }}
      storybook_storage_account_name: ${{ steps.get-terraform-outputs.outputs.storybook-storage-account-name }}
      storybook_web_endpoint: ${{ steps.get-terraform-outputs.outputs.storybook-web-endpoint }}
      storybook_cdn_endpoint_name: ${{ steps.get-terraform-outputs.outputs.storybook-cdn-endpoint-name }}
      api_base_url: ${{ steps.get-terraform-outputs.outputs.api-base-url }}
      api_endpoints: ${{ steps.get-terraform-outputs.outputs.api-endpoints }}
      myaccounts_home_url: ${{ steps.get-terraform-outputs.outputs.myaccounts-home-url }}
      gtm_env_auth: ${{ steps.get-terraform-outputs.outputs.gtm-env-auth }}
      gtm_env_preview: ${{ steps.get-terraform-outputs.outputs.gtm-env-preview }}

  open_staging_storage_account_firewalls:
    name: "Open storage account firewalls for uploads"
    environment: staging
    runs-on: ubuntu-latest
    needs: [deploy_staging_rg_terraform, deploy_staging_terraform]
    steps:
      - name: "Login to Azure"
        uses: Azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: "Set default rule to allow to enable uploads"
        uses: azure/CLI@v1
        with:
          azcliversion: latest
          inlineScript: |
            az storage account update --resource-group ${{ needs.deploy_staging_rg_terraform.outputs.resource_group_name }} --name ${{ needs.deploy_staging_terraform.outputs.storybook_storage_account_name }} --default-action Allow
            az storage account update --resource-group ${{ needs.deploy_staging_rg_terraform.outputs.resource_group_name }} --name ${{ needs.deploy_staging_terraform.outputs.frontend_storage_account_name }} --default-action Allow

  deploy_staging_frontend:
    name: "Deploy staging front end"
    environment: staging
    needs:
      - build_cache
      - deploy_staging_rg_terraform
      - deploy_staging_terraform
      - open_staging_storage_account_firewalls
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout"
        uses: actions/checkout@v2

      - name: "Use Node.js 14.x"
        uses: actions/setup-node@v1
        with:
          node-version: 14.x

      - name: "Get yarn cache"
        uses: actions/cache@v2
        with:
          key: ${{ needs.build_cache.outputs.key }}
          path: ${{ needs.build_cache.outputs.yarn-path }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: "Get node modules cache"
        uses: actions/cache@v2
        with:
          key: ${{ needs.build_cache.outputs.key }}
          path: ${{ needs.build_cache.outputs.modules-path }}
          restore-keys: |
            ${{ runner.os }}-modules-

      - name: "Create env file"
        working-directory: ./packages/hybrid-frontend
        run: |
          touch .env.staging
          echo 'API_ENDPOINTS=${{ needs.deploy_staging_terraform.outputs.api_endpoints }}' >> .env.staging
          echo 'API_BASE_URL=${{ needs.deploy_staging_terraform.outputs.api_base_url }}' >> .env.staging
          echo 'MYACCOUNTS_HOME_URL=${{ needs.deploy_staging_terraform.outputs.myaccounts_home_url }}' >> .env.staging
          echo 'GTM_AUTH=${{ needs.deploy_staging_terraform.outputs.gtm_env_auth }}' >> .env.staging
          echo 'GTM_PREVIEW=${{ needs.deploy_staging_terraform.outputs.gtm_env_preview }}' >> .env.staging
          echo 'AI_CONNECTION_STRING=${{ secrets.AI_CONNECTION_STRING }}' >> .env.staging
          cat .env.staging

      - name: "Gatsby Build"
        run: GATSBY_ACTIVE_ENV=staging yarn frontend build

      - name: "Login to Azure"
        uses: Azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # TODO check timings of uploads and parelellise if necessary
      - name: "Upload build artifacts"
        uses: azure/CLI@v1
        with:
          azcliversion: latest
          inlineScript: |
            az storage blob upload-batch \
              --source $GITHUB_WORKSPACE/packages/hybrid-frontend/public \
              --destination "${{needs.deploy_staging_rg_terraform.outputs.artifact_container_name}}" \
              --account-name "${{needs.deploy_staging_rg_terraform.outputs.artifact_storage_account_name}}" \
              --destination-path "${{github.sha}}/"

      - name: "Deploy Gatsby static website"
        uses: azure/CLI@v1
        with:
          azcliversion: latest
          inlineScript: |
            az storage container create --name '$web' --account-name "${{ needs.deploy_staging_terraform.outputs.frontend_storage_account_name }}"
            az storage blob delete-batch --account-name "${{ needs.deploy_staging_terraform.outputs.frontend_storage_account_name }}" --source '$web'
            az storage blob upload-batch -s $GITHUB_WORKSPACE/packages/hybrid-frontend/public -d "\$web" --account-name "${{ needs.deploy_staging_terraform.outputs.frontend_storage_account_name }}"

  deploy_storybook:
    name: "Deploy Storybook"
    environment: staging
    needs:
      - build_cache
      - deploy_staging_terraform
      - open_staging_storage_account_firewalls
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout"
        uses: actions/checkout@v2

      - name: "Use Node.js 14.x"
        uses: actions/setup-node@v1
        with:
          node-version: 14.x

      - name: "Get yarn cache"
        uses: actions/cache@v2
        with:
          key: ${{ needs.build_cache.outputs.key }}
          path: ${{ needs.build_cache.outputs.yarn-path }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: "Get node modules cache"
        uses: actions/cache@v2
        with:
          key: ${{ needs.build_cache.outputs.key }}
          path: ${{ needs.build_cache.outputs.modules-path }}
          restore-keys: |
            ${{ runner.os }}-modules-

      - name: "Create env file"
        working-directory: ./packages/react-components
        run: |
          touch .env.production
          echo 'API_ENDPOINTS=${{ needs.deploy_staging_terraform.outputs.api_endpoints }}' >> .env.production
          echo 'API_BASE_URL=${{ needs.deploy_staging_terraform.outputs.api_base_url }}' >> .env.production
          echo 'MYACCOUNTS_HOME_URL=${{ needs.deploy_staging_terraform.outputs.myaccounts_home_url }}' >> .env.production
          echo 'GTM_AUTH=${{ needs.deploy_staging_terraform.outputs.gtm_env_auth }}' >> .env.production
          echo 'GTM_PREVIEW=${{ needs.deploy_staging_terraform.outputs.gtm_env_preview }}' >> .env.production
          echo 'AI_CONNECTION_STRING=${{ secrets.AI_CONNECTION_STRING }}' >> .env.production
          cat .env.production

      - name: "Build Storybook"
        run: GATSBY_ACTIVE_ENV=production yarn components build-storybook -o "./storybook-static"

      - name: "Login to Azure"
        uses: Azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: "Deploy Storybook as static website"
        uses: azure/CLI@v1
        with:
          azcliversion: latest
          inlineScript: |
            az storage container create --name '$web' --account-name "${{ needs.deploy_staging_terraform.outputs.storybook_storage_account_name }}"
            az storage blob delete-batch --account-name "${{ needs.deploy_staging_terraform.outputs.storybook_storage_account_name }}" --source '$web'
            az storage blob upload-batch -s $GITHUB_WORKSPACE/packages/react-components/storybook-static -d "\$web" --account-name "${{ needs.deploy_staging_terraform.outputs.storybook_storage_account_name }}"

  purge_storybook_cdn_cache:
    name: "Purge storybook CDN cache"
    if: needs.deploy_storybook.result == 'success'
    environment: staging
    runs-on: ubuntu-latest
    needs:
      - deploy_staging_rg_terraform
      - deploy_staging_apim_terraform
      - deploy_staging_terraform
      - deploy_storybook
    steps:
      - name: "Login to Azure"
        uses: Azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: "Purge storybook CDN cache"
        uses: azure/CLI@v1
        with:
          azcliversion: latest
          inlineScript: |
            az cdn endpoint purge --resource-group ${{ needs.deploy_staging_rg_terraform.outputs.resource_group_name }} --name ${{needs.deploy_staging_terraform.outputs.storybook_cdn_endpoint_name}} --profile-name ${{ needs.deploy_staging_apim_terraform.outputs.cdn_profile_storybook_name }} --content-paths '/*'

  deploy_staging_front_door:
    name: "Deploy staging Front Door"
    environment: staging
    needs:
      - deploy_staging_rg_terraform
      - deploy_staging_terraform
      - deploy_staging_frontend
    runs-on: ubuntu-latest
    env:
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: 93b71b78-b75b-4806-8282-97b9e70ae16c
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      TF_INPUT: false
    steps:
      - name: "Checkout"
        uses: actions/checkout@v2

      - name: "Setup Terraform"
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: 0.14.7
          terraform_wrapper: false

      - name: "Terraform Init"
        working-directory: ./terraform/front_door
        run: |
          terraform init \
            -lock-timeout=15m \
            -backend-config="./backends/staging.backend"

      - name: "Terraform Plan"
        working-directory: ./terraform/front_door
        run: |
          terraform plan \
            -lock-timeout=15m \
            -var-file="./var-files/staging.tfvars" \
            -out="staging-fd-plan.tfplan"
        env:
          TF_VAR_resource_group_name: ${{ needs.deploy_staging_rg_terraform.outputs.resource_group_name }}
          TF_VAR_cdn_endpoint_host: ${{ needs.deploy_staging_terraform.outputs.frontend_web_host }}

      - name: "Terraform Apply"
        working-directory: ./terraform/front_door
        run: |
          terraform apply \
            -lock-timeout=15m \
            -auto-approve \
            staging-fd-plan.tfplan

  close_staging_storage_account_firewalls:
    name: "Close storage account firewalls for uploads"
    environment: staging
    runs-on: ubuntu-latest
    needs:
      - deploy_staging_rg_terraform
      - deploy_staging_terraform
      - deploy_staging_frontend
    steps:
      - name: "Login to Azure"
        uses: Azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: "Set default rule to allow to enable uploads"
        uses: azure/CLI@v1
        with:
          azcliversion: latest
          inlineScript: |
            az storage account update --resource-group ${{ needs.deploy_staging_rg_terraform.outputs.resource_group_name }} --name ${{ needs.deploy_staging_terraform.outputs.storybook_storage_account_name }} --default-action Deny
            az storage account update --resource-group ${{ needs.deploy_staging_rg_terraform.outputs.resource_group_name }} --name ${{ needs.deploy_staging_terraform.outputs.frontend_storage_account_name }} --default-action Deny

  purge_staging_frontend_cdn_cache:
    name: "Purge staging frontend CDN cache"
    if: needs.deploy_staging_frontend.result == 'success'
    environment: staging
    runs-on: ubuntu-latest
    needs:
      - deploy_staging_rg_terraform
      - deploy_staging_apim_terraform
      - deploy_staging_terraform
      - deploy_staging_frontend
    steps:
      - name: "Login to Azure"
        uses: Azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: "Purge frontend CDN cache"
        uses: azure/CLI@v1
        with:
          azcliversion: latest
          inlineScript: |
            az cdn endpoint purge --resource-group ${{ needs.deploy_staging_rg_terraform.outputs.resource_group_name }} --name ${{needs.deploy_staging_terraform.outputs.website_cdn_endpoint_name}} --profile-name ${{ needs.deploy_staging_apim_terraform.outputs.cdn_profile_website_name }} --content-paths '/*'

  deploy_production_rg_terraform:
    name: "Deploy prod Resource Group"
    environment: prod
    needs: [ deploy_staging_front_door ]
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./terraform/resource_group
    env:
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: 211bb550-03e5-4e25-8e32-05ee16ac07eb
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      TF_INPUT: false
    steps:
      - name: "Checkout"
        uses: actions/checkout@v2

      - name: "Setup Terraform"
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: 0.14.7
          terraform_wrapper: false

      - name: "Terraform Init"
        run: |
          terraform init \
            -lock-timeout=15m \
            -backend-config="./backends/prod.backend"

      - name: "Terraform Validate"
        run: terraform validate -no-color

      - name: "Terraform Plan"
        id: rg-plan
        run: |
          terraform plan \
            -lock-timeout=15m \
            -var-file="./var-files/prod.tfvars" \
            -out="prod-rg-plan.tfplan"

      - name: "Terraform Apply"
        run: |
          terraform apply \
            -lock-timeout=15m \
            -auto-approve \
            prod-rg-plan.tfplan

      - name: "Set Terraform Outputs"
        id: set-terraform-outputs
        run: |
          terraform output -json > prod-rg-outputs.json
          echo ::set-output name=resource-group-name::$( jq -r .resource_group_name.value prod-rg-outputs.json )
          echo ::set-output name=artifact-storage-account-name::$( jq -r .artifact_storage_account_name.value prod-rg-outputs.json )
          echo ::set-output name=artifact-container-name::$(  jq -r .artifact_container_name.value prod-rg-outputs.json )
          echo ::set-output name=test-artifacts-container-name::$( jq -r .test_artifacts_container_name.value prod-rg-outputs.json )

    outputs:
      resource_group_name: ${{ steps.set-terraform-outputs.outputs.resource-group-name }}
      artifact_storage_account_name: ${{ steps.set-terraform-outputs.outputs.artifact-storage-account-name }}
      artifact_container_name: ${{ steps.set-terraform-outputs.outputs.artifact-container-name }}
      test_artifacts_container_name: ${{ steps.set-terraform-outputs.outputs.test-artifacts-container-name }}

  deploy_production_apim_terraform:
    name: "Deploy prod APIM"
    environment: prod
    needs: [ deploy_production_rg_terraform ]
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./terraform/apim
    env:
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: 211bb550-03e5-4e25-8e32-05ee16ac07eb
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      TF_INPUT: false
    steps:
      - name: "Checkout"
        uses: actions/checkout@v2

      - name: "Setup Terraform"
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: 0.14.7
          terraform_wrapper: false

      - name: "Terraform Init"
        run: |
          terraform init \
            -lock-timeout=15m \
            -backend-config="./backends/prod.backend"

      - name: "Terraform Validate"
        run: terraform validate -no-color

      - name: "Terraform Plan"
        run: |
          terraform plan \
            -lock-timeout=15m \
            -var-file="./var-files/prod.tfvars" \
            -out="prod-apim-plan.tfplan"
        env:
          TF_VAR_resource_group_name: ${{ needs.deploy_production_rg_terraform.outputs.resource_group_name }}
          TF_VAR_myaccount_signing_key: ${{ secrets.MYACCOUNTS_SIGNING_KEY}}
          TF_VAR_xplan_username: ${{ secrets.XPLAN_USERNAME}}
          TF_VAR_xplan_password: ${{ secrets.XPLAN_PASSWORD}}
          TF_VAR_myaccount_guest_username: ${{ secrets.MYACCOUNT_GUEST_USERNAME}}
          TF_VAR_myaccount_guest_password: ${{ secrets.MYACCOUNT_GUEST_PASSWORD}}
          TF_VAR_xplan_app_id: ${{ secrets.XPLAN_APP_ID}}
          TF_VAR_slack_security_alert_webhook_url: ${{ secrets.SLACK_SECURITY_ALERT_WEBHOOK_URL }}

      - name: "Terraform Apply"
        run: |
          terraform apply \
            -lock-timeout=15m \
            -auto-approve \
            prod-apim-plan.tfplan

      - name: "Set Terraform Outputs"
        id: set-terraform-outputs
        run: |
          terraform output -json > prod-apim-outputs.json
          echo ::set-output name=apim-name::$( jq -r .apim_name.value prod-apim-outputs.json )
          echo ::set-output name=apim-vnet-name::$( jq -r .apim_vnet_name.value prod-apim-outputs.json )
          echo ::set-output name=apim-subnet-name::$( jq -r .apim_subnet_name.value prod-apim-outputs.json )
          echo ::set-output name=cdn-profile-website-name::$( jq -r .cdn_profile_website_name.value prod-apim-outputs.json )
          echo ::set-output name=cdn-profile-storybook-name::$( jq -r .cdn_profile_storybook_name.value prod-apim-outputs.json )
          echo ::set-output name=app-insights-name::$( jq -r .app_insights_name.value prod-apim-outputs.json )

    outputs:
      apim_name: ${{ steps.set-terraform-outputs.outputs.apim-name }}
      apim_vnet_name: ${{ steps.set-terraform-outputs.outputs.apim-vnet-name }}
      apim_subnet_name: ${{ steps.set-terraform-outputs.outputs.apim-subnet-name }}
      cdn_profile_website_name: ${{ steps.set-terraform-outputs.outputs.cdn-profile-website-name }}
      cdn_profile_storybook_name: ${{ steps.set-terraform-outputs.outputs.cdn-profile-storybook-name }}
      app_insights_name: ${{ steps.set-terraform-outputs.outputs.app-insights-name }}

  deploy_production_terraform:
    name: "Deploy prod infrastructure."
    environment: prod
    needs:
      - deploy_production_rg_terraform
      - deploy_production_apim_terraform
      - package_function_apps
    runs-on: ubuntu-latest
    env:
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: 211bb550-03e5-4e25-8e32-05ee16ac07eb
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      TF_INPUT: false
    steps:
      - name: "Checkout"
        uses: actions/checkout@v2

      - name: "Download function app zips"
        uses: actions/download-artifact@v2
        with:
          name: ${{ needs.package_function_apps.outputs.artifact-name }}
          path: ./terraform/infra/zips

      - name: "Setup Terraform"
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: 0.14.7
          terraform_wrapper: false

      - name: "Terraform Init"
        working-directory: ./terraform/infra
        run: |
          terraform init \
            -lock-timeout=15m \
            -backend-config="./backends/prod.backend"

      - name: "Terraform Validate"
        working-directory: ./terraform/infra
        run: terraform validate -no-color

      - name: "Terraform Plan"
        working-directory: ./terraform/infra
        run: |
          terraform plan \
            -lock-timeout=15m \
            -var-file="./var-files/prod.tfvars" \
            -out="prod-infra-plan.tfplan"
        env:
          TF_VAR_resource_group_name: ${{ needs.deploy_production_rg_terraform.outputs.resource_group_name }}
          TF_VAR_apim_name: ${{ needs.deploy_production_apim_terraform.outputs.apim_name }}
          TF_VAR_apim_vnet_name: ${{ needs.deploy_production_apim_terraform.outputs.apim_vnet_name }}
          TF_VAR_apim_subnet_name: ${{ needs.deploy_production_apim_terraform.outputs.apim_subnet_name }}
          TF_VAR_cdn_profile_website_name: ${{ needs.deploy_production_apim_terraform.outputs.cdn_profile_website_name }}
          TF_VAR_cdn_profile_storybook_name: ${{ needs.deploy_production_apim_terraform.outputs.cdn_profile_storybook_name }}
          TF_VAR_app_insights_name: ${{ needs.deploy_production_apim_terraform.outputs.app_insights_name }}
          TF_VAR_git_branch_name: ${{ github.head_ref }}

      - name: "Terraform Apply"
        working-directory: ./terraform/infra
        run: |
          terraform apply \
            -lock-timeout=15m \
            -auto-approve \
            prod-infra-plan.tfplan

      - name: "Get Terraform Outputs"
        id: get-terraform-outputs
        working-directory: ./terraform/infra
        run: |
          terraform output -json > prod-infra-outputs.json
          echo ::set-output name=frontend-storage-account-name::$( jq -r .frontend_storage_account_name.value prod-infra-outputs.json )
          echo ::set-output name=frontend-web-host::$( jq -r .frontend_web_host.value prod-infra-outputs.json )
          echo ::set-output name=website-endpoint::$( jq -r .frontend_web_endpoint.value prod-infra-outputs.json )
          echo ::set-output name=website-cdn-endpoint-name::$( jq -r .frontend_cdn_endpoint_name.value prod-infra-outputs.json )
          echo ::set-output name=website-cname::$( jq -r .frontend_web_cname.value prod-infra-outputs.json )
          echo ::set-output name=api-base-url::$( jq -r .api_base_url.value prod-infra-outputs.json )
          echo ::set-output name=api-endpoints::$( jq -r .api_endpoints.value prod-infra-outputs.json )
          echo ::set-output name=myaccounts-home-url::$( jq -r .myaccounts_home_url.value prod-infra-outputs.json )
          echo ::set-output name=gtm-env-auth::$( jq -r .gtm_env_auth.value prod-infra-outputs.json )
          echo ::set-output name=gtm-env-preview::$( jq -r .gtm_env_preview.value prod-infra-outputs.json )
    outputs:
      frontend_storage_account_name: ${{ steps.get-terraform-outputs.outputs.frontend-storage-account-name }}
      frontend_web_host: ${{ steps.get-terraform-outputs.outputs.frontend-web-host }}
      website_endpoint: ${{ steps.get-terraform-outputs.outputs.website-endpoint }}
      website_cdn_endpoint_name: ${{ steps.get-terraform-outputs.outputs.website-cdn-endpoint-name }}
      website_cname: ${{ steps.get-terraform-outputs.outputs.website-cname }}
      api_base_url: ${{ steps.get-terraform-outputs.outputs.api-base-url }}
      api_endpoints: ${{ steps.get-terraform-outputs.outputs.api-endpoints }}
      myaccounts_home_url: ${{ steps.get-terraform-outputs.outputs.myaccounts-home-url }}
      gtm_env_auth: ${{ steps.get-terraform-outputs.outputs.gtm-env-auth }}
      gtm_env_preview: ${{ steps.get-terraform-outputs.outputs.gtm-env-preview }}

  open_prod_storage_account_firewalls:
    name: "Open storage account firewalls for uploads"
    environment: prod
    runs-on: ubuntu-latest
    needs: [ deploy_production_rg_terraform, deploy_production_terraform ]
    steps:
      - name: "Login to Azure"
        uses: Azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: "Set default rule to allow to enable uploads"
        uses: azure/CLI@v1
        with:
          azcliversion: latest
          inlineScript: |
            az storage account update --resource-group ${{ needs.deploy_production_rg_terraform.outputs.resource_group_name }} --name ${{ needs.deploy_production_terraform.outputs.frontend_storage_account_name }} --default-action Allow

  deploy_production_frontend:
    name: "Deploy production front end"
    environment: prod
    needs:
      - build_cache
      - deploy_production_rg_terraform
      - deploy_production_terraform
      - open_prod_storage_account_firewalls
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout"
        uses: actions/checkout@v2

      - name: "Use Node.js 14.x"
        uses: actions/setup-node@v1
        with:
          node-version: 14.x

      - name: "Get yarn cache"
        uses: actions/cache@v2
        with:
          key: ${{ needs.build_cache.outputs.key }}
          path: ${{ needs.build_cache.outputs.yarn-path }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: "Get node modules cache"
        uses: actions/cache@v2
        with:
          key: ${{ needs.build_cache.outputs.key }}
          path: ${{ needs.build_cache.outputs.modules-path }}
          restore-keys: |
            ${{ runner.os }}-modules-

      - name: "Create env file"
        working-directory: ./packages/hybrid-frontend
        run: |
          touch .env.production
          echo 'API_ENDPOINTS=${{ needs.deploy_production_terraform.outputs.api_endpoints }}' >> .env.production
          echo 'API_BASE_URL=${{ needs.deploy_production_terraform.outputs.api_base_url }}' >> .env.production
          echo 'MYACCOUNTS_HOME_URL=${{ needs.deploy_production_terraform.outputs.myaccounts_home_url }}' >> .env.production
          echo 'GTM_AUTH=${{ needs.deploy_production_terraform.outputs.gtm_env_auth }}' >> .env.production
          echo 'GTM_PREVIEW=${{ needs.deploy_production_terraform.outputs.gtm_env_preview }}' >> .env.production
          echo 'AI_CONNECTION_STRING=${{ secrets.AI_CONNECTION_STRING }}' >> .env.production
          cat .env.production

      - name: "Gatsby build"
        run: GATSBY_ACTIVE_ENV=production yarn frontend build

      - name: "Login to Azure"
        uses: Azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # TODO check timings of uploads and parelellise if necessary
      - name: "Upload build artifacts"
        uses: azure/CLI@v1
        with:
          azcliversion: latest
          inlineScript: |
            az storage blob upload-batch \
              --source $GITHUB_WORKSPACE/packages/hybrid-frontend/public \
              --destination "${{needs.deploy_production_rg_terraform.outputs.artifact_container_name}}" \
              --account-name "${{needs.deploy_production_rg_terraform.outputs.artifact_storage_account_name}}" \
              --destination-path "${{github.sha}}/"

      - name: "Deploy frontend as static website"
        uses: azure/CLI@v1
        with:
          azcliversion: latest
          inlineScript: |
            az storage container create --name '$web' --account-name "${{ needs.deploy_production_terraform.outputs.frontend_storage_account_name }}"
            az storage blob delete-batch --account-name "${{ needs.deploy_production_terraform.outputs.frontend_storage_account_name }}" --source '$web'
            az storage blob upload-batch -s $GITHUB_WORKSPACE/packages/hybrid-frontend/public -d "\$web" --account-name "${{ needs.deploy_production_terraform.outputs.frontend_storage_account_name }}"

  deploy_production_front_door:
    name: "Deploy prod Front Door"
    environment: prod
    needs:
      - deploy_production_rg_terraform
      - deploy_production_terraform
      - deploy_production_frontend
    runs-on: ubuntu-latest
    env:
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: 211bb550-03e5-4e25-8e32-05ee16ac07eb
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      TF_INPUT: false
    steps:
      - name: "Checkout"
        uses: actions/checkout@v2

      - name: "Setup Terraform"
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: 0.14.7
          terraform_wrapper: false

      - name: "Terraform Init"
        working-directory: ./terraform/front_door
        run: |
          terraform init \
            -lock-timeout=15m \
            -backend-config="./backends/prod.backend"

      - name: "Terraform Plan"
        working-directory: ./terraform/front_door
        run: |
          terraform plan \
            -lock-timeout=15m \
            -var-file="./var-files/prod.tfvars" \
            -out="prod-fd-plan.tfplan"
        env:
          TF_VAR_resource_group_name: ${{ needs.deploy_production_rg_terraform.outputs.resource_group_name }}
          TF_VAR_cdn_endpoint_host: ${{ needs.deploy_production_terraform.outputs.frontend_web_host }}

      - name: "Terraform Apply"
        working-directory: ./terraform/front_door
        run: |
          terraform apply \
            -lock-timeout=15m \
            -auto-approve \
            prod-fd-plan.tfplan

      - name: "Get Terraform Outputs"
        id: get-terraform-outputs
        run: |
          terraform output -json > prod-fd-outputs.json
          echo ::set-output name=site-url::$( jq -r .site_url.value prod-fd-outputs.json )

    outputs:
      site_url: ${{ steps.get-terraform-outputs.outputs.site-url }}

  close_prod_storage_account_firewalls:
    name: "Close storage account firewalls for uploads"
    environment: prod
    runs-on: ubuntu-latest
    needs:
      - deploy_production_rg_terraform
      - deploy_production_terraform
      - deploy_production_frontend
    steps:
      - name: "Login to Azure"
        uses: Azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: "Set default rule to allow to enable uploads"
        uses: azure/CLI@v1
        with:
          azcliversion: latest
          inlineScript: |
            az storage account update --resource-group ${{ needs.deploy_production_rg_terraform.outputs.resource_group_name }} --name ${{ needs.deploy_production_terraform.outputs.frontend_storage_account_name }} --default-action Deny

  purge_prod_frontend_cdn_cache:
    name: "Purge prod frontend CDN cache"
    if: needs.deploy_production_frontend.result == 'success'
    environment: prod
    runs-on: ubuntu-latest
    needs:
      - deploy_production_rg_terraform
      - deploy_production_apim_terraform
      - deploy_production_terraform
      - deploy_production_frontend
    steps:
      - name: "Login to Azure"
        uses: Azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: "Purge frontend CDN cache"
        uses: azure/CLI@v1
        with:
          azcliversion: latest
          inlineScript: |
            az cdn endpoint purge --resource-group ${{ needs.deploy_production_rg_terraform.outputs.resource_group_name }} --name ${{needs.deploy_production_terraform.outputs.website_cdn_endpoint_name}} --profile-name ${{ needs.deploy_production_apim_terraform.outputs.cdn_profile_website_name }} --content-paths '/*'

  output_website_urls:
    name: "Output website urls"
    needs: [ deploy_staging_terraform, deploy_production_terraform ]
    runs-on: ubuntu-latest
    steps:
      - name: "Get website urls"
        shell: bash
        run: |
          echo "Staging website endpoint: ${{ needs.deploy_staging_terraform.outputs.website_endpoint }}"
          echo "Staging website cname: ${{ needs.deploy_staging_terraform.outputs.website_cname }}"
          echo "Staging Storybook endpoint: ${{ needs.deploy_staging_terraform.outputs.storybook_web_endpoint }}"
          echo "Production website endpoint: ${{ needs.deploy_production_terraform.outputs.website_endpoint }}"
          echo "Production website cname: ${{ needs.deploy_production_terraform.outputs.website_cname }}"

  post-to-slack:
    name: "Post to Slack"
    if: always()
    environment: prod
    needs:
      - build_cache
      - build_windows_cache
      - package_function_apps
      - deploy_staging_rg_terraform
      - deploy_staging_apim_terraform
      - deploy_staging_terraform
      - open_staging_storage_account_firewalls
      - deploy_staging_frontend
      - deploy_storybook
      - purge_storybook_cdn_cache
      - deploy_staging_front_door
      - close_staging_storage_account_firewalls
      - purge_staging_frontend_cdn_cache
      - deploy_production_rg_terraform
      - deploy_production_apim_terraform
      - deploy_production_terraform
      - open_prod_storage_account_firewalls
      - deploy_production_frontend
      - deploy_production_front_door
      - close_prod_storage_account_firewalls
      - purge_prod_frontend_cdn_cache
      - output_website_urls
    runs-on: ubuntu-latest
    steps:
      - name: "Set variables"
        id: set-variables
        run: |
          echo ::set-output name=current-timestamp::$( date +%s )
          if [[
            "${{
              needs.build_cache.result == 'success' &&
              needs.build_windows_cache.result == 'success' &&
              needs.package_function_apps.result == 'success' &&
              needs.deploy_staging_rg_terraform.result == 'success' &&
              needs.deploy_staging_apim_terraform.result == 'success' &&
              needs.deploy_staging_terraform.result == 'success' &&
              needs.open_staging_storage_account_firewalls.result == 'success' &&
              needs.deploy_storybook.result == 'success' &&
              needs.deploy_staging_frontend.result == 'success' &&
              needs.purge_storybook_cdn_cache.result == 'success' &&
              needs.deploy_staging_front_door.result == 'success' &&
              needs.close_staging_storage_account_firewalls.result == 'success' &&
              needs.purge_staging_frontend_cdn_cache.result == 'success' &&
              needs.deploy_production_rg_terraform.result == 'success' &&
              needs.deploy_production_apim_terraform.result == 'success' &&
              needs.deploy_production_terraform.result == 'success' &&
              needs.open_prod_storage_account_firewalls.result == 'success' &&
              needs.deploy_production_frontend.result == 'success' &&
              needs.deploy_production_front_door.result == 'success' &&
              needs.close_prod_storage_account_firewalls.result == 'success' &&
              needs.purge_prod_frontend_cdn_cache.result == 'success' &&
              needs.output_website_urls.result == 'success'
            }}" == "true"
          ]]; then
            echo ::set-output name=deployment-status::success
          else
            echo ::set-output name=deployment-status::failure
          fi

      - name: "Post to slack"
        uses: 8398a7/action-slack@v3
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          status: custom
          custom_payload: |
            {
              attachments: [{
                "color": '${{ steps.set-variables.outputs.deployment-status }}' === 'success' ? '#009933' : '#cc0000',
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": '${{ steps.set-variables.outputs.deployment-status }}' === 'success' ? 'Deployment Success :rocket:' : 'Deployment Failed :rotating_light:',
                      "emoji": true
                    }
                  },
                  {
                    "type": "divider"
                  },
                  {
                    "type": "context",
                    "elements": [
                      {
                        "type": "mrkdwn",
                        "text": "*Workflow Name* : ${{ github.workflow }}"
                      }
                    ]
                  },
                  {
                    "type": "context",
                    "elements": [
                      {
                        "type": "mrkdwn",
                        "text": "*Deployment initiated by*:"
                      },
                      {
                        "type": "image",
                        "image_url": "https://github.com/${{ github.actor }}.png?size=40",
                        "alt_text": "Authors Avatar"
                      },
                      {
                        "type": "plain_text",
                        "text": "${{ github.actor }}",
                        "emoji": true
                      }
                    ]
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": '${{ steps.set-variables.outputs.deployment-status }}' === 'success' ? ':heavy-check-mark:   *Deployment Status*: Success' : ':heavy-cross-mark:   *Deployment Status*: Failure'
                    }
                  },
                  {
                    "type": "divider"
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*Job Conclusions for this workflow run.*"
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": '${{ needs.build_cache.result }}' === 'success' ? ':heavy-check-mark:   Build Cache' : '${{ needs.build_cache.result }}' === 'failure' ? ':heavy-cross-mark:   Build Cache' : ':heavy-minus-sign:   Build Cache'
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": '${{ needs.build_windows_cache.result }}' === 'success' ? ':heavy-check-mark:   Build Windows Cache' : '${{ needs.build_windows_cache.result }}' === 'failure' ? ':heavy-cross-mark:   Build Windows Cache' : ':heavy-minus-sign:   Build Windows Cache'
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": '${{ needs.package_function_apps.result }}' === 'success' ? ':heavy-check-mark:   Package Function Apps' : '${{ needs.package_function_apps.result }}' === 'failure' ? ':heavy-cross-mark:   Package Function Apps' : ':heavy-minus-sign:   Package Function Apps'
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": '${{ needs.deploy_staging_rg_terraform.result }}' === 'success' ? ':heavy-check-mark:   Deploy Staging Resource Group' : '${{ needs.deploy_staging_rg_terraform.result }}' === 'failure' ? ':heavy-cross-mark:   Deploy Staging Resource Group' : ':heavy-minus-sign:   Deploy Staging Resource Group'
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": '${{ needs.deploy_staging_apim_terraform.result }}' === 'success' ? ':heavy-check-mark:   Deploy Staging APIM' : '${{ needs.deploy_staging_apim_terraform.result }}' === 'failure' ? ':heavy-cross-mark:   Deploy Staging APIM' : ':heavy-minus-sign:   Deploy Staging APIM'
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": '${{ needs.deploy_staging_terraform.result }}' === 'success' ? ':heavy-check-mark:   Deploy Staging Terraform' : '${{ needs.deploy_staging_terraform.result }}' === 'failure' ? ':heavy-cross-mark:   Deploy Staging Terraform' : ':heavy-minus-sign:   Deploy Staging Terraform'
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": '${{ needs.open_staging_storage_account_firewalls.result }}' === 'success' ? ':heavy-check-mark:   Open Staging Storage Account Firewalls' : '${{ needs.open_staging_storage_account_firewalls.result }}' === 'failure' ? ':heavy-cross-mark:   Open Staging Storage Account Firewalls' : ':heavy-minus-sign:   Open Staging Storage Account Firewalls'
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": '${{ needs.deploy_staging_frontend.result }}' === 'success' ? ':heavy-check-mark:   Deploy Staging Frontend' : '${{ needs.deploy_staging_frontend.result }}' === 'failure' ? ':heavy-cross-mark:   Deploy Staging Frontend' : ':heavy-minus-sign:   Deploy Staging Frontend'
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": '${{ needs.deploy_storybook.result }}' === 'success' ? ':heavy-check-mark:   Deploy Storybook' : '${{ needs.deploy_storybook.result }}' === 'failure' ? ':heavy-cross-mark:   Deploy Storybook' : ':heavy-minus-sign:   Deploy Storybook'
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": '${{ needs.purge_storybook_cdn_cache.result }}' === 'success' ? ':heavy-check-mark:   Purge Storybook CDN Cache' : '${{ needs.purge_storybook_cdn_cache.result }}' === 'failure' ? ':heavy-cross-mark:   Purge Storybook CDN Cache' : ':heavy-minus-sign:   Purge Storybook CDN Cache'
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": '${{ needs.deploy_production_rg_terraform.result }}' === 'success' ? ':heavy-check-mark:   Deploy Production Resource Group' : '${{ needs.deploy_production_rg_terraform.result }}' === 'failure' ? ':heavy-cross-mark:   Deploy Production Resource Group' : ':heavy-minus-sign:   Deploy Production Resource Group'
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": '${{ needs.close_staging_storage_account_firewalls.result }}' === 'success' ? ':heavy-check-mark:   Close Staging Storage Account Firewalls' : '${{ needs.close_staging_storage_account_firewalls.result }}' === 'failure' ? ':heavy-cross-mark:   Close Staging Storage Account Firewalls' : ':heavy-minus-sign:   Close Staging Storage Account Firewalls'
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": '${{ needs.purge_staging_frontend_cdn_cache.result }}' === 'success' ? ':heavy-check-mark:   Purge Staging Frontend CDN Cache' : '${{ needs.purge_staging_frontend_cdn_cache.result }}' === 'failure' ? ':heavy-cross-mark:   Purge Staging Frontend CDN Cache' : ':heavy-minus-sign:   Purge Staging Frontend CDN Cache'
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": '${{ needs.deploy_production_rg_terraform.result }}' === 'success' ? ':heavy-check-mark:   Deploy Production RG Terraform' : '${{ needs.deploy_production_rg_terraform.result }}' === 'failure' ? ':heavy-cross-mark:   Deploy Production RG Terraform' : ':heavy-minus-sign:   Deploy Production RG Terraform'
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": '${{ needs.deploy_production_apim_terraform.result }}' === 'success' ? ':heavy-check-mark:   Deploy Production APIM Terraform' : '${{ needs.deploy_production_apim_terraform.result }}' === 'failure' ? ':heavy-cross-mark:   Deploy Production APIM Terraform' : ':heavy-minus-sign:   Deploy Production APIM Terraform'
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": '${{ needs.deploy_production_terraform.result }}' === 'success' ? ':heavy-check-mark:   Deploy Production Terraform' : '${{ needs.deploy_production_terraform.result }}' === 'failure' ? ':heavy-cross-mark:   Deploy Production Terraform' : ':heavy-minus-sign:   Deploy Production Terraform'
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": '${{ needs.open_prod_storage_account_firewalls.result }}' === 'success' ? ':heavy-check-mark:   Open Prod Storage Account Firewalls' : '${{ needs.open_prod_storage_account_firewalls.result }}' === 'failure' ? ':heavy-cross-mark:   Open Prod Storage Account Firewalls' : ':heavy-minus-sign:   Open Prod Storage Account Firewalls'
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": '${{ needs.deploy_production_frontend.result }}' === 'success' ? ':heavy-check-mark:   Deploy Production Frontend' : '${{ needs.deploy_production_frontend.result }}' === 'failure' ? ':heavy-cross-mark:   Deploy Production Frontend' : ':heavy-minus-sign:   Deploy Production Frontend'
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": '${{ needs.deploy_production_front_door.result }}' === 'success' ? ':heavy-check-mark:   Deploy Prod Front Door' : '${{ needs.deploy_production_front_door.result }}' === 'failure' ? ':heavy-cross-mark:   Deploy Prod Front Door' : ':heavy-minus-sign:   Deploy Prod Front Door'
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": '${{ needs.close_prod_storage_account_firewalls.result }}' === 'success' ? ':heavy-check-mark:   Close Prod Storage Account Firewalls' : '${{ needs.close_prod_storage_account_firewalls.result }}' === 'failure' ? ':heavy-cross-mark:   Close Prod Storage Account Firewalls' : ':heavy-minus-sign:   Close Prod Storage Account Firewalls'
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": '${{ needs.purge_prod_frontend_cdn_cache.result }}' === 'success' ? ':heavy-check-mark:   Purge Prod Frontend CDN Cache' : '${{ needs.purge_prod_frontend_cdn_cache.result }}' === 'failure' ? ':heavy-cross-mark:   Purge Prod Frontend CDN Cache' : ':heavy-minus-sign:   Purge Prod Frontend CDN Cache'
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": '${{ needs.output_website_urls.result }}' === 'success' ? ':heavy-check-mark:   Output Website Urls' : '${{ needs.output_website_urls.result }}' === 'failure' ? ':heavy-cross-mark:   Output Website Urls' : ':heavy-minus-sign:   Output Website Urls'
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": '${{ job.status }}' === 'success' ? ':heavy-check-mark:   Post to Slack' : '${{ job.status }}' === 'failure' ? ':heavy-cross-mark:   Post to Slack' : ':heavy-minus-sign:   Post to Slack'
                    }
                  },
                  {
                    "type": "divider"
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*Useful link for this workflow run.*"
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": ":hammer_and_wrench:   Workflow run for this deployment"
                    },
                    "accessory": {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "Workflow run",
                        "emoji": true
                      },
                      "value": "Link to this run instance",
                      "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                      "action_id": "button-action"
                    }
                  },
                  {
                    "type": "divider"
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*Storybook and Website links for Staging and Production environments.*"
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": ":jigsaw:   Storybook"
                    },
                    "accessory": {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View storybook",
                        "emoji": true
                      },
                      "value": "Link to Storybook website",
                      "url": '${{ needs.deploy_production_terraform.result }}' === 'success' && '${{ needs.deploy_storybook.result }}' === 'success' ? '${{ needs.deploy_staging_terraform.outputs.storybook_web_endpoint }}' : 'https://www.google.com/404.html',
                      "action_id": "button-action"
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": ":globe_with_meridians:   Digital-Hybrid website - Staging"
                    },
                    "accessory": {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View website - Staging",
                        "emoji": true
                      },
                      "value": "Link to DH website - Staging",
                      "url": '${{ needs.deploy_staging_terraform.result }}' === 'success' && '${{ needs.deploy_staging_frontend.result }}' === 'success' ? '${{ needs.deploy_staging_terraform.outputs.website_cname }}' : 'https://www.google.com/404.html',
                      "action_id": "button-action"
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": ":globe_with_meridians:   Digital-Hybrid website - Production"
                    },
                    "accessory": {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View website - Production",
                        "emoji": true
                      },
                      "value": "Link to DH website - Production",
                      "url": '${{ needs.deploy_production_terraform.result }}' === 'success' && '${{ needs.deploy_production_frontend.result }}' === 'success' ? '${{ needs.deploy_production_terraform.outputs.website_cname }}' : 'https://www.google.com/404.html',
                      "action_id": "button-action"
                    }
                  },
                  {
                    "type": "divider"
                  },
                  {
                    "type": "context",
                    "elements": [
                      {
                        "type": "mrkdwn",
                        "text": ":airplane_arriving: *<!date^${{ steps.set-variables.outputs.current-timestamp }}^Posted on {date_long} at {time_secs}|Date and Time of this message when it was posted.>*"
                      }
                    ]
                  }
                ]
              }]
            }
